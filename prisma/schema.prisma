generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String   @id @default(uuid())
  avatar       String?
  name         String
  email        String   @unique
  password     String
  role         Role     @default(user)
  workingHours Json?
  createdAt    DateTime @default(now())
  assigned     Ticket[] @relation("TechTickets")
  tickets      Ticket[] @relation("UserTickets")

  passwordResetTokens PasswordResetToken[]
}

model Ticket {
  id               String             @id @default(uuid())
  publicID         String             @unique
  title            String
  description      String
  status           Status             @default(open)
  amount           Float              @default(0)
  serviceID        String
  userID           String
  technicianID     String?
  updatedAt        DateTime           @updatedAt
  createdAt        DateTime           @default(now())
  service          Service            @relation("ServiceTickets", fields: [serviceID], references: [id])
  technician       User?              @relation("TechTickets", fields: [technicianID], references: [id], onDelete: Cascade)
  user             User               @relation("UserTickets", fields: [userID], references: [id], onDelete: Cascade)
  subService       SubService[]       @relation("SubServiceTicketsOnTicket")
  TicketSubService TicketSubService[]
}

model Service {
  id      String   @id @default(uuid())
  title   String   @unique
  value   String
  status  Boolean  @default(true)
  tickets Ticket[] @relation("ServiceTickets")
}

model SubService {
  id               String             @id @default(uuid())
  title            String             @unique
  value            Float
  tickets          Ticket[]           @relation("SubServiceTicketsOnTicket")
  TicketSubService TicketSubService[]
}

model TicketSubService {
  ticketId     String
  subServiceId String

  ticket     Ticket     @relation(fields: [ticketId], references: [id])
  subService SubService @relation(fields: [subServiceId], references: [id])

  @@id([ticketId, subServiceId])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  token     String // código enviado por e-mail (ex: "839201")
  expiresAt DateTime // expiração (ex: agora + 10 minutos)
  usedAt    DateTime? // se já foi usado
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

enum Role {
  admin
  user
  technician
}

enum Status {
  open
  finished
  inProgress
}
